---
title: 浏览器中的多进程与多线程
tags:
  - 浏览器
categories: 技术
abbrlink: 8536
date: 2021-05-12 10:25:16
---



## 一.进程与线程

### **1.什么是进程和线程**

**进程**是CPU资源分配的最小单位（是能拥有资源和独立运行的最小单位），在一定的环境下，把静态的程序代码运行起来，通过使用不同的资源，来完成一定的任务。

**线程**是CPU调度的最小单位（线程是建立在进程的基础上的一次程序运行单位，一个进程中可以有多个线程，个进程中的线程可以互相通信，共享内存等资源，不同进程之间也可以通信，不过代价较大。）

<!--more-->

举个例子：

- 假如进程是一个工厂，工厂有它的独立的资源
- 工厂之间相互独立
- 线程是工厂中的工人，多个工人协作完成任务
- 工厂内有一个或多个工人
- 工人之间共享空间

再完善完善概念：

- 工厂的资源 -> 系统分配的内存（独立的一块内存）
- 工厂之间的相互独立 -> 进程之间相互独立
- 多个工人协作完成任务 -> 多个线程在进程中协作完成任务
- 工厂内有一个或多个工人 -> 一个进程由一个或多个线程组成
- 工人之间共享空间 -> 同一进程下的各个线程之间共享程序的内存空间（包括代码段、数据集、堆等）

### **2.进程和线程的关系**

进程是计算机中的程序关于某数据集合上的一次运行活动，是系统进行资源分配和调度的基本单位，是操作系统结构的基础。或者说进程是具有一定独立功能的程序关于某个数据集合上的一次运行活动,进程是系统进行资源分配和调度的一个独立单位。

线程则是进程的一个实体,是CPU调度和分派的基本单位,它是比进程更小的能独立运行的基本单位。

总结来说，进程和线程之间的关系有以下 4 个特点。

- 进程中的任意一线程执行出错，都会导致整个进程的崩溃。
- 线程之间共享进程中的数据。
- 当一个进程关闭之后，操作系统会回收进程所占用的内存。
- 进程之间的内容相互隔离。

### **3.什么是多进程和多线程？**

多进程：多进程指同一个时间里，同一个计算机系统中如果允许两个或两个以上的进程处于运行状态。多进程带来的好处多个程序互不影响

多线程是指程序中包含多个执行流，即在一个程序中可以同时运行多个不同的线程来执行不同的任务，也就是说允许单个程序创建多个并行执行的线程来完成各自的任务。



## 二.多进程浏览器

### **1.什么是多进程浏览器**

多进程浏览器使用多个进程来隔离不同的网页。因此在多进程浏览器中打开一个网页相当于起了一个进程，如在某一浏览器中打开一个tab页，就是一个进程。

### **2.为什么要使用多进程架构?**

根本考虑：性能和安全

防止病毒攻击网站中的一个进程导致整个网站奔溃。

相比线程：多进程不共享资源和地址空间，不会有太多的安全问题，线程共享资源和地址，因此可能会受到恶意攻击

**多进程浏览器内存等资源消耗也会更大，有点空间换时间的意思。**

### **3.多进程浏览器的多进程有哪些？**

- 浏览器进程：浏览器的主进程（负责协调，主控）
- 插件进程：每种类型的插件对应一个进程，仅当使用该插件时才创建
- GPU进程：最多一个，用于3D绘制
- **浏览器渲染进程（内核）**：默认每个Tab页面一个进程，互不影响，控制页面渲染，脚本执行，事件处理等（有时候会优化，如多个空白tab会合并成一个进程）

### **4.多进程浏览器的优点？**

- 避免页面渲染影响整个浏览器
- 避免第三方插件影响整个浏览器
- 多进程充分利用多核优势
- 方便使用沙盒模型隔离插件等进程，提高浏览器稳定性



## 三.多线程浏览器

### **1.浏览器内核是多线程**

浏览器内核是多线程，在内核控制下各线程相互配合以保持同步，一个浏览器通常由以下常驻线程组成：

- GUI 渲染线程
- JavaScript引擎线程
- 定时触发器线程
- 事件触发线程
- 异步http请求线程

#### **JavaScript引擎线程**

负责处理JavaScript脚本程序

javascript引擎是基于事件驱动单线程执行的，JS引擎一直等待着任务队列中任务的到来，然后加以处理，浏览器无论什么时候都只有一个JS线程在运行JS程序

#### GUI渲染线程

负责渲染浏览器界面,重绘(repaint)或回流(reflow)时,该线程就会执行。

与javascript引擎线程是互斥，js引擎执行时,GUI线程就会被挂起,GUI更新会被保存在一个队列中,等待js引擎空闲时立即被执行。

特殊情况是整个html渲染时的生命周期,会通过全局事件如DOMContentLoaded,onresize进行描述

#### 事件触发线程

事件触发线程，当一个事件被触发时,该线程会把事件添加到待处理队列的队尾，等待JS引擎的处理。

这些事件可来自JavaScript引擎当前执行的代码块如setTimeOut、也可来自浏览器内核的其他线程如鼠标点击、AJAX异步请求等，但由于JS的单线程关系所有这些事件都得排队等待JS引擎处理。

#### **定时触发器线程**

传说中的setInterval与setTimeout所在线程, 计数线程，浏览器定时计数器并不是由JS引擎计数的

#### **异步http请求线程**

XMLHttpRequest在连接后是通过浏览器新开的一个线程请求。当检测到状态更新时，如果没有设置回调函数，异步线程就产生状态 变更事件，将这个回调再放入事件队列中，等待JS引擎执行。

### **2.浏览器内核中线程之间的关系**

#### **a.GUI渲染线程与JavaScript引擎线程互斥！**

由于JavaScript是可操纵DOM的，如果在修改这些元素属性同时渲染界面（即JavaScript线程和UI线程同时运行），那么渲染线程前后获得的元素数据就可能不一致了。

因此为了防止渲染出现不可预期的结果，浏览器设置GUI渲染线程与JavaScript引擎为互斥的关系，当JavaScript引擎执行时GUI线程会被挂起，GUI更新会被保存在一个队列中等到引擎线程空闲时立即被执行。

#### **b.JS阻塞页面加载**

由于GUI渲染线程与JavaScript执行线程是互斥的关系，当浏览器在执行JavaScript程序的时候，GUI渲染线程会被保存在一个队列中，直到JS程序执行完成，才会接着执行。

因此如果JS执行的时间过长，这样就会造成页面的渲染不连贯，导致页面渲染加载阻塞的感觉。

### c.JS引擎线程与事件触发线程、定时触发器线程、异步HTTP请求线程

事件触发线程、定时触发器线程、异步HTTP请求线程三个线程有一个共同点，那就是使用回调函数的形式，当满足了特定的条件，这些回调函数会被执行。

这些回调函数被浏览器内核理解成事件，在浏览器内核中拥有一个事件队列，这三个线程当满足了内部特定的条件，会将这些回调函数添加到事件队列中，等待JS引擎空闲执行。

例如异步HTTP请求线程，线程如果检测到请求的状态变更，如果设置有回调函数，回调函数会被添加事件队列中，等待JS引擎空闲了执行。

但是，JS引擎对事件队列（宏任务）与JS引擎内的任务（微任务）执行存在着先后循序，当每执行完一个事件队列的时间，JS引擎会检测内部是否有未执行的任务，如果有，将会优先执行（微任务）。